// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// User & Authentication
enum UserRole {
  ADMIN
  MANAGER
  STOCK_MASTER // As per requirements
  STAFF
}

model User {
  id             String    @id @default(cuid())
  email          String    @unique
  password       String // Hashed password
  name           String?
  role           UserRole  @default(STAFF)
  otp            String? // For password reset
  otpExpiry      DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
}

// Product Management
model Category {
  id          String    @id @default(cuid())
  name        String    @unique
  description String?
  
  // Hierarchy: Parent Category
  parentId    String?
  parent      Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryHierarchy")

  products    Product[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

enum ProductType {
  STORABLE   // Track stock
  CONSUMABLE // Don't track stock, but allow reception/delivery
  SERVICE    // No stock, no delivery
}

model Product {
  id            String   @id @default(cuid())
  name          String
  sku           String   @unique
  barcode       String?  @unique // Scannable barcode
  description   String?
  type          ProductType @default(STORABLE)
  
  unitOfMeasure String   @default("Units") // e.g., kg, pcs, m
  
  costPrice     Decimal  @default(0.00)
  salesPrice    Decimal  @default(0.00)

  categoryId    String?
  category      Category? @relation(fields: [categoryId], references: [id])

  minStock      Int      @default(0) // Reordering rule
  maxStock      Int?     // Reordering rule
  
  image         String?  // URL or base64

  stockLevels   StockLevel[]
  stockMoves    StockMove[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// Warehouse & Locations
model Warehouse {
  id        String     @id @default(cuid())
  name      String
  address   String?
  locations Location[]
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
}

enum LocationType {
  VIEW           // Generic parent location (e.g. "Warehouse A")
  INTERNAL       // Standard stock location (e.g. "Shelf 1")
  CUSTOMER       // Goods sent to customers
  VENDOR         // Goods received from vendors
  INVENTORY_LOSS // For adjustments/scrapping
  PRODUCTION     // Manufacturing location
  TRANSIT        // Inter-warehouse transit
}

model Location {
  id          String       @id @default(cuid())
  name        String
  type        LocationType @default(INTERNAL)
  
  // Hierarchy: Parent Location (e.g., Warehouse -> Zone -> Rack -> Shelf)
  parentId    String?
  parent      Location?    @relation("LocationHierarchy", fields: [parentId], references: [id])
  children    Location[]   @relation("LocationHierarchy")

  warehouseId String?
  warehouse   Warehouse?   @relation(fields: [warehouseId], references: [id])

  stockLevels StockLevel[]

  // Relations for moves
  movesFrom   StockMove[]  @relation("SourceLocation")
  movesTo     StockMove[]  @relation("DestinationLocation")

  // Relations for transfers
  transfersFrom StockTransfer[] @relation("SourceLocation")
  transfersTo   StockTransfer[] @relation("DestinationLocation")

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Current Stock (Quants)
model StockLevel {
  id         String   @id @default(cuid())
  productId  String
  product    Product  @relation(fields: [productId], references: [id])
  
  locationId String
  location   Location @relation(fields: [locationId], references: [id])
  
  quantity   Int      @default(0)

  updatedAt  DateTime @updatedAt

  @@unique([productId, locationId]) // Unique stock record per product per location
}

// Operations
enum TransferType {
  INCOMING   // Receipt
  OUTGOING   // Delivery
  INTERNAL   // Internal Transfer
  ADJUSTMENT // Inventory Adjustment
}

enum TransferStatus {
  DRAFT
  WAITING
  READY
  DONE
  CANCELED
}

model Contact {
  id        String          @id @default(cuid())
  name      String
  email     String?
  phone     String?
  type      ContactType     @default(CUSTOMER)
  address   String?
  transfers StockTransfer[]
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
}

enum ContactType {
  VENDOR
  CUSTOMER
}

// The "Document" (Receipt, Delivery Order, etc.)
model StockTransfer {
  id                    String         @id @default(cuid())
  reference             String         @unique // e.g., WH/IN/0001
  origin                String?        // Source document (e.g., PO001, SO002)
  type                  TransferType
  status                TransferStatus @default(DRAFT)

  sourceLocationId      String?
  sourceLocation        Location?      @relation("SourceLocation", fields: [sourceLocationId], references: [id])

  destinationLocationId String?
  destinationLocation   Location?      @relation("DestinationLocation", fields: [destinationLocationId], references: [id])

  contactId             String?
  contact               Contact?       @relation(fields: [contactId], references: [id])

  scheduledDate         DateTime?
  effectiveDate         DateTime?      // When it actually happened
  
  stockMoves            StockMove[]

  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt
}

// The individual lines in a transfer
model StockMove {
  id                    String         @id @default(cuid())
  transferId            String?
  transfer              StockTransfer? @relation(fields: [transferId], references: [id])

  productId             String
  product               Product        @relation(fields: [productId], references: [id])

  quantity              Int

  sourceLocationId      String?
  sourceLocation        Location?      @relation("SourceLocation", fields: [sourceLocationId], references: [id])

  destinationLocationId String?
  destinationLocation   Location?      @relation("DestinationLocation", fields: [destinationLocationId], references: [id])

  status                TransferStatus @default(DRAFT)

  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt
}
